<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Blocked Extension Policy</title>
    <style>
        :root {
            --bg: #f6f4ef;
            --ink: #1f2933;
            --accent: #0f766e;
            --muted: #6b7280;
            --card: #ffffff;
            --danger: #b91c1c;
        }
        body {
            margin: 0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #fdfcf9 0%, #f2efe9 100%);
            color: var(--ink);
        }
        .container {
            max-width: 960px;
            margin: 40px auto;
            padding: 0 20px 60px;
        }
        header {
            margin-bottom: 24px;
        }
        header h1 {
            font-size: 28px;
            margin: 0 0 6px;
        }
        header p {
            margin: 0;
            color: var(--muted);
        }
        .nav {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 18px 0 24px;
        }
        .nav button {
            border: 1px solid #d1d5db;
            background: #fff;
            color: var(--ink);
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
        }
        .nav button.active {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 6px 16px rgba(15, 118, 110, 0.18);
        }
        .page {
            display: none;
        }
        .page.show {
            display: block;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(31, 41, 51, 0.08);
            padding: 18px;
        }
        .card h2 {
            margin-top: 0;
            font-size: 18px;
        }
        .fixed-list {
            display: grid;
            gap: 8px;
        }
        .fixed-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #e5e7eb;
            padding: 8px 10px;
            border-radius: 8px;
        }
        .fixed-item label {
            display: flex;
            gap: 8px;
            align-items: center;
            font-weight: 600;
        }
        .muted {
            color: var(--muted);
            font-size: 12px;
        }
        .custom-input {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .custom-input input {
            flex: 1;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }
        .custom-input button {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            background: var(--accent);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        .custom-list {
            display: grid;
            gap: 8px;
            max-height: 360px;
            overflow-y: auto;
        }
        .custom-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e5e7eb;
            padding: 8px 10px;
            border-radius: 8px;
        }
        .custom-item button {
            border: none;
            background: transparent;
            color: var(--danger);
            font-weight: 700;
            cursor: pointer;
        }
        .status {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            background: #fef2f2;
            color: var(--danger);
            display: none;
        }
        .status.show {
            display: block;
        }
        .info {
            font-size: 12px;
            color: var(--muted);
        }
        .hero {
            display: grid;
            gap: 12px;
        }
        .hero-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .action-btn {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            background: var(--accent);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }
        .action-btn.secondary {
            background: #1f2933;
        }
        .upload-form {
            display: grid;
            gap: 12px;
        }
        .upload-form input[type="file"] {
            padding: 10px;
            border: 1px dashed #cbd5f5;
            border-radius: 10px;
            background: #f8fafc;
        }
        .upload-status {
            padding: 10px 12px;
            border-radius: 8px;
            background: #ecfeff;
            color: #0f766e;
            display: none;
        }
        .upload-status.show {
            display: block;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>File Upload Console</h1>
        <p>Upload files safely and manage blocked extensions.</p>
    </header>

    <div class="nav">
        <button class="nav-btn active" data-target="homeSection">Home</button>
        <button class="nav-btn" data-target="uploadSection">Upload</button>
        <button class="nav-btn" data-target="policySection">Blocked Extensions</button>
    </div>

    <section class="page show" id="homeSection">
        <div class="card hero">
            <h2>Welcome</h2>
            <p class="muted">Use the quick actions below to upload files or manage the blocked list.</p>
            <div class="hero-actions">
                <button class="action-btn" data-target="uploadSection">Upload a file</button>
                <button class="action-btn secondary" data-target="policySection">Block extensions</button>
            </div>
        </div>
    </section>

    <section class="page" id="uploadSection">
        <div class="card">
            <h2>Upload File</h2>
            <form class="upload-form" id="uploadForm">
                <input id="uploadInput" type="file" />
                <button class="action-btn" type="submit">Upload to /api/v1/upload</button>
                <div class="upload-status" id="uploadStatus"></div>
            </form>
            <p class="info">Max size: 10MB. Blocked extensions will be rejected by the server.</p>
        </div>
    </section>

    <section class="page" id="policySection">
        <div class="grid">
            <section class="card">
                <h2>Fixed Extensions</h2>
                <div class="fixed-list" id="fixedList"></div>
                <p class="info">Fixed extensions are not shown in the custom list.</p>
            </section>

            <section class="card">
                <h2>Custom Extensions</h2>
                <div class="custom-input">
                    <input id="customInput" type="text" maxlength="20" placeholder="e.g. zip" />
                    <button id="addCustomButton">Add</button>
                </div>
                <div class="muted" id="customCount">0 / 200</div>
                <div class="custom-list" id="customList"></div>
                <div class="status" id="statusBox"></div>
            </section>
        </div>
    </section>
</div>

<script>
    const navButtons = document.querySelectorAll('.nav-btn');
    const actionButtons = document.querySelectorAll('.action-btn[data-target]');
    const pages = document.querySelectorAll('.page');
    const fixedList = document.getElementById('fixedList');
    const customList = document.getElementById('customList');
    const customCount = document.getElementById('customCount');
    const statusBox = document.getElementById('statusBox');
    const customInput = document.getElementById('customInput');
    const addCustomButton = document.getElementById('addCustomButton');
    const uploadForm = document.getElementById('uploadForm');
    const uploadInput = document.getElementById('uploadInput');
    const uploadStatus = document.getElementById('uploadStatus');
    const MAX_UPLOAD_BYTES = 10 * 1024 * 1024;

    function setActiveNav(targetId) {
        navButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.target === targetId);
        });
    }

    function showSection(targetId) {
        pages.forEach(page => {
            page.classList.toggle('show', page.id === targetId);
        });
        setActiveNav(targetId);
    }

    function showError(message) {
        statusBox.textContent = message;
        statusBox.classList.add('show');
        setTimeout(() => statusBox.classList.remove('show'), 4000);
    }

    async function loadFixed() {
        const response = await fetch('/api/v1/extensions/fixed');
        const data = await response.json();
        fixedList.innerHTML = '';
        data.forEach(item => {
            const row = document.createElement('div');
            row.className = 'fixed-item';
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = item.enabled;
            checkbox.addEventListener('change', async () => {
                try {
                    const res = await fetch(`/api/v1/extensions/fixed/${item.extension}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ enabled: checkbox.checked })
                    });
                    if (!res.ok) {
                        const err = await res.json();
                        showError(err.message || 'Failed to update.');
                        checkbox.checked = !checkbox.checked;
                    }
                } catch (err) {
                    showError('Network error.');
                    checkbox.checked = !checkbox.checked;
                }
            });
            const name = document.createElement('span');
            name.textContent = item.extension;
            label.appendChild(checkbox);
            label.appendChild(name);
            row.appendChild(label);
            fixedList.appendChild(row);
        });
    }

    async function loadCustom() {
        const response = await fetch('/api/v1/extensions/custom');
        const data = await response.json();
        customList.innerHTML = '';
        data.forEach(item => {
            const row = document.createElement('div');
            row.className = 'custom-item';
            const name = document.createElement('span');
            name.textContent = item.extension;
            const btn = document.createElement('button');
            btn.textContent = 'X';
            btn.addEventListener('click', async () => {
                const res = await fetch(`/api/v1/extensions/custom/${item.id}`, { method: 'DELETE' });
                if (res.ok) {
                    await loadCustom();
                } else {
                    const err = await res.json();
                    showError(err.message || 'Failed to delete.');
                }
            });
            row.appendChild(name);
            row.appendChild(btn);
            customList.appendChild(row);
        });
        customCount.textContent = `${data.length} / 200`;
    }

    addCustomButton.addEventListener('click', async () => {
        const value = customInput.value;
        if (!value || value.trim() === '') {
            showError('Enter an extension.');
            return;
        }
        try {
            const res = await fetch('/api/v1/extensions/custom', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ extension: value })
            });
            if (res.ok) {
                customInput.value = '';
                await loadCustom();
            } else {
                const err = await res.json();
                showError(err.message || 'Failed to add.');
            }
        } catch (err) {
            showError('Network error.');
        }
    });

    function showUploadStatus(message, isError) {
        uploadStatus.textContent = message;
        uploadStatus.style.background = isError ? '#fef2f2' : '#ecfeff';
        uploadStatus.style.color = isError ? '#b91c1c' : '#0f766e';
        uploadStatus.classList.add('show');
        setTimeout(() => uploadStatus.classList.remove('show'), 5000);
    }

    uploadForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!uploadInput.files || uploadInput.files.length === 0) {
            showUploadStatus('Select a file to upload.', true);
            return;
        }
        if (uploadInput.files[0].size > MAX_UPLOAD_BYTES) {
            showUploadStatus('File size exceeds 10MB. Upload not allowed.', true);
            return;
        }
        const formData = new FormData();
        formData.append('file', uploadInput.files[0]);
        try {
            const res = await fetch('/api/v1/upload', {
                method: 'POST',
                body: formData
            });
            if (res.ok) {
                const text = await res.text();
                showUploadStatus(text || 'Upload complete.', false);
                uploadInput.value = '';
            } else {
                let message = 'Upload failed.';
                try {
                    const err = await res.json();
                    message = err.message || message;
                } catch (e) {
                    const text = await res.text();
                    message = text || message;
                }
                showUploadStatus(message, true);
            }
        } catch (err) {
            showUploadStatus('Network error.', true);
        }
    });

    navButtons.forEach(btn => {
        btn.addEventListener('click', () => showSection(btn.dataset.target));
    });

    actionButtons.forEach(btn => {
        btn.addEventListener('click', () => showSection(btn.dataset.target));
    });

    Promise.all([loadFixed(), loadCustom()]);
</script>
</body>
</html>
